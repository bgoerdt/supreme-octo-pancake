<!DOCTYPE html>
<html>
  <head>
    <style>
       #map {
        height: 400px;
        width: 100%;
       }
    </style>
  </head>
  <body>
    <h3>My Google Maps Demo</h3>

    <h3>Fentanyl Filters</h3>
    <p>Date of Testing</p>
    <span>From: <input id="fentanyl-startdate" type="date" /></span>
    <span>To: <input id="fentanyl-enddate" type="date" /></span>
    
    <p>Drug Type</p>
    <input id="fentanyl-drugtype-meth" type="checkbox" value="Methamphetamine" />
    <label for="fentanyl-drugtype-meth">Methamphetamine</label><br/>

    <input id="fentanyl-drugtype-opioids" type="checkbox" value="Opioids" />
    <label for="fentanyl-drugtype-opioids">Opioids</label><br/>

    <input id="fentanyl-drugtype-heroin" type="checkbox" value="Heroin" />
    <label for="fentanyl-drugtype-heroin">Heroin</label><br/>

    <input id="fentanyl-drugtype-crack" type="checkbox" value="Crack/Cocaine" />
    <label for="fentanyl-drugtype-crack">Crack/Cocaine</label><br/>

    <input id="fentanyl-drugtype-other" type="checkbox" value="Other not on the list" />
    <label for="fentanyl-drugtype-other">Other not on the list</label><br/>

    <p>Use of Test Strips</p>
    <input id="fentanyl-use-before" type="checkbox" value="Before drug use" />
    <label for="fentanyl-use-before">Before using the drug</label><br/>

    <input id="fentanyl-use-after" type="checkbox" value="After drug use" />
    <label for="fentanyl-use-after">After using the drug</label><br/>

    <p>Test Results</p>
    <input id="fentanyl-results-positive" type="checkbox" value="Positive" />
    <label for="fentanyl-results-positive">Positive</label><br/>

    <input id="fentanyl-results-negative" type="checkbox" value="Negative" />
    <label for="fentanyl-results-negative">Negative</label><br/>

    <input id="fentanyl-results-none" type="checkbox" value="Didn\u00e2\u0080\u0099t work" />
    <label for="fentanyl-results-none">Didn't work</label><br/>

    <p>Actions</p>
    <input id="fentanyl-actions-sameamount" type="checkbox" value="i-used-the-same-amount-of-drugs-as-i-planned" />
    <label for="fentanyl-actions-sameamount">I used the same amount of drugs as I planned</label><br/>

    <input id="fentanyl-actions-less" type="checkbox" value="i-used-less-amount-of-drugs-than-i-planned" />
    <label for="fentanyl-actions-less">I used less amount of drugs than I planned</label><br/>

    <input id="fentanyl-actions-slowplunger" type="checkbox" value="i-pushed-plunger-more-slowly-than-usual" />
    <label for="fentanyl-actions-slowplunger">I pushed plunger more slowly than usual</label><br/>

    <input id="fentanyl-actions-plungerpartway" type="checkbox" value="i-pushed-plunger-partway-to-feel-how-strong-the-drug-was" />
    <label for="fentanyl-actions-plungerpartway">I pushed plunger partway to feel how strong the drug was</label><br/>

    <input id="fentanyl-actions-sniffed" type="checkbox" value="i-sniffed-it-instead-of-shooting" />
    <label for="fentanyl-actions-sniffed">I sniffed it instead of shooting it</label><br/>

    <input id="fentanyl-actions-threwaway" type="checkbox" value="i-threw-the-drugs-away" />
    <label for="fentanyl-actions-threwaway">I threw the drugs away</label><br/>

    <input id="fentanyl-actions-lookafter" type="checkbox" value="i-got-someone-to-look-after-me" />
    <label for="fentanyl-actions-lookafter">I got someone to look after me</label><br/>

    <input id="fentanyl-actions-sharedresults" type="checkbox" value="i-shared-the-test-results-with-other-people-who-use-the-same-drug" />
    <label for="fentanyl-actions-sharedresults">I shared the test results with other people who use the same drug</label><br/>

    <input id="fentanyl-actions-other" type="checkbox" value="other-not-on-the-list" />
    <label for="fentanyl-actions-other">Other not on the list</label><br/>

    <p>Method of Use</p>
    <input id="fentanyl-method-inject" type="checkbox" value="i-injected-it" />
    <label for="fentanyl-method-inject">I injected it</label><br/>

    <input id="fentanyl-method-snorted" type="checkbox" value="i-snorted-or-sniffed-it" />
    <label for="fentanyl-method-snorted">I snorted or sniffed it</label><br/>

    <input id="fentanyl-method-smoked" type="checkbox" value="i-smoked-it" />
    <label for="fentanyl-method-smoked">I smoked it</label><br/>

    <input id="fentanyl-method-didnotuse" type="checkbox" value="I didn\u00e2\u0080\u0099t use it" />
    <label for="fentanyl-method-didnotuse">I didn't use it</label><br/>

    <input id="fentanyl-method-other" type="checkbox" value="other-not-listed" />
    <label for="fentanyl-method-other">Other not listed</label><br/>

    <p>Under 30</p>
    <input id="fentanyl-under30-yes" type="checkbox" value="yes" />
    <label for="fentanyl-under30-yes">Yes</label><br/>
    
    <input id="fentanyl-under30-no" type="checkbox" value="no" />  
    <label for="fentanyl-under30-no">No</label><br/>


    <h3>Naloxone Filters</h3>
    <p>Date of Testing</p>
    <span>From: <input id="naloxone-startdate" type="date" /></span>
    <span>To: <input id="naloxone-enddate" type="date" /></span>
    
    <p>Administration Type</p>
    <input id="naloxone-admintype-injection" type="checkbox" value="Intermuscular Injection" />
    <label for="naloxone-admintype-injection">Intermuscular Injection</label><br/>

    <input id="naloxone-admintype-auto" type="checkbox" value="Auto-Injector" />
    <label for="naloxone-admintype-auto">Auto-Injector</label><br/>

    <input id="naloxone-admintype-spray" type="checkbox" value="Nasal Spray" />
    <label for="naloxone-admintype-spray">Nasal Spray</label><br/>

    
    <p>Drug Type</p>
    <input id="naloxone-drugtype-meth" type="checkbox" value="methamphetamine" />
    <label for="naloxone-drugtype-meth">Methamphetamine</label><br/>

    <input id="naloxone-drugtype-heroin" type="checkbox" value="heroin" />
    <label for="naloxone-drugtype-heroin">Heroin</label><br/>

    <input id="naloxone-drugtype-opioids" type="checkbox" value="opioids-prescription-pills" />
    <label for="naloxone-drugtype-opioids">Opioids or Prescription Pills</label><br/>

    <input id="naloxone-drugtype-crack" type="checkbox" value="crack-cocaine" />
    <label for="naloxone-drugtype-crack">Crack/Cocaine</label><br/>

    <input id="naloxone-drugtype-other" type="checkbox" value="other-not-listed" />
    <label for="naloxone-drugtype-other">Other not on the list</label><br/>
    
    <p>Source</p>
    <input id="naloxone-source-ihrc" type="checkbox" value="IHRC" />
    <label for="naloxone-source-ihrc">Iowa Harm Reduction Coalition</label><br/>

    <input id="naloxone-source-emergency" type="checkbox" value="Emergency Medical Provider" />
    <label for="naloxone-source-emergency">Emergency Medical Provider</label><br/>

    <input id="naloxone-source-law" type="checkbox" value="Law Enforcement" />
    <label for="naloxone-source-law">Law Enforcement</label><br/>

    <input id="naloxone-source-substance" type="checkbox" value="Substance Use Disorder Treatment" />
    <label for="naloxone-source-substance">Substance Use Disorder Treatment</label><br/>

    <input id="naloxone-source-pharmacy" type="checkbox" value="Pharmacy" />
    <label for="naloxone-source-pharmacy">Pharmacy</label><br/>

    <input id="naloxone-source-other" type="checkbox" value="Other" />
    <label for="naloxone-source-other">Other</label><br/>

    <p>Under 30</p>
    <input id="naloxone-under30-yes" type="checkbox" value="yes" />
    <label for="naloxone-under30-yes">Yes</label><br/>
    
    <input id="naloxone-under30-no" type="checkbox" value="no" />  
    <label for="naloxone-under30-no">No</label><br/>


    <button id="update-filters-button" type="button">Update Map</button>

    <div style="position: relative">
      <div id="map"></div>
      <div id="hover-details" style="position: absolute; top: 10px; left: 10px; z-index: 99; display: none; background-color: white; border-color: gray; border-radius: 4px; padding: 16px;">
          <div id="hover-details-title"></div>
          <div id="hover-details-content"></div>
        </div>
    </div>
    <script>
      var mapStyles = [
        {
          "featureType": "administrative",
          "elementType": "geometry",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "administrative.land-parcel",
          "elementType": "labels",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "poi",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "poi",
          "elementType": "labels.text",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "road",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "road",
          "elementType": "labels.icon",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "road.local",
          "elementType": "labels",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "transit",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        }
      ];

      var map, markers, fentanylSourceData, naloxoneSourceData;

      var fentanylFilterInputs = {
        drugType: [
          'fentanyl-drugtype-meth',
          'fentanyl-drugtype-opioids',
          'fentanyl-drugtype-heroin',
          'fentanyl-drugtype-crack',
          'fentanyl-drugtype-other'
        ],
        beforeOrAfter: [
          'fentanyl-use-before',
          'fentanyl-use-after'
        ],
        result: [
          'fentanyl-results-positive',
          'fentanyl-results-negative',
          'fentanyl-results-none'
        ],
        actions: [
          'fentanyl-actions-sameamount',
          'fentanyl-actions-less',
          'fentanyl-actions-slowplunger',
          'fentanyl-actions-plungerpartway',
          'fentanyl-actions-sniffed',
          'fentanyl-actions-threwaway',
          'fentanyl-actions-lookafter',
          'fentanyl-actions-sharedresults',
          'fentanyl-actions-other'
        ],
        method: [
          'fentanyl-method-inject',
          'fentanyl-method-snorted',
          'fentanyl-method-smoked',
          'fentanyl-method-didnotuse',
          'fentanyl-method-other'
        ],
        under30: [
          'fentanyl-under30-yes',
          'fentanyl-under30-no'
        ]
      };

      var naloxoneFilterInputs = {
        administrationType: [
          'naloxone-admintype-injection',
          'naloxone-admintype-auto',
          'naloxone-admintype-spray'
        ],
        drugType: [
          'naloxone-drugtype-meth',
          'naloxone-drugtype-opioids',
          'naloxone-drugtype-heroin',
          'naloxone-drugtype-crack',
          'naloxone-drugtype-other'
        ],
        source: [
          'naloxone-source-ihrc',
          'naloxone-source-emergency',
          'naloxone-source-law',
          'naloxone-source-substance',
          'naloxone-source-pharmacy',
          'naloxone-source-other'
        ],
        under30: [
          'fentanyl-under30-yes',
          'fentanyl-under30-no'
        ]
      };

      function applyFentanylFilters() {
        var fentanylFilters = getFilterValues(fentanylFilterInputs);

        var startDate = document.getElementById('fentanyl-startdate').value;
        var endDate = document.getElementById('fentanyl-enddate').value;

        fentanylFilters.startDate = startDate ? startDate : undefined;
        fentanylFilters.endDate = endDate ? endDate : undefined;

        let recordFilter = new RecordFilter(fentanylSourceData);
        setupFentanylFilters(fentanylFilters, recordFilter);

        var filteredData = recordFilter.applyFilters();
        var filteredFentanylZipCodeHash = transformResultsToZipCodeHash(filteredData);

        initializeZipCodeMapData(filteredFentanylZipCodeHash);
      }

      function applyNaloxoneFilters() {
        var naloxoneFilters = getFilterValues(naloxoneFilterInputs);

        var startDate = document.getElementById('naloxone-startdate').value;
        var endDate = document.getElementById('naloxone-enddate').value;

        naloxoneFilters.startDate = startDate ? startDate : undefined;
        naloxoneFilters.endDate = endDate ? endDate : undefined;

        let recordFilter = new RecordFilter(fentanylSourceData);
        setupFentanylFilters(naloxoneFilters, recordFilter);

        var filteredData = recordFilter.applyFilters();

        clearMarkers();
        initializeMarkerClusterData(filteredData);
      }

      function applyFilters() {
        applyFentanylFilters();
        applyNaloxoneFilters();
      }

      function getFilterValues(filterInputs) {
        return Object.keys(filterInputs).reduce((acc, filterInputKey) => {
          filterInputs[filterInputKey].forEach((filterInputId) => {
            var element = document.getElementById(filterInputId);
            if(element.checked) {
              if(acc[filterInputKey]) {
                acc[filterInputKey].push(element.value);
              } else {
                acc[filterInputKey] = [element.value]
              }
            }
          });

          return acc;
        }, {});
      }

      function getNaloxoneResults() {
        fetch('naloxone.json')
          .then(response => {
            return response.json();
        }).then((responseJson) => {
          naloxoneSourceData = responseJson;
          initializeMarkerClusterData(naloxoneSourceData);
        });
      }

      function getFentanylResults() {
        fetch('fentanyl.json')
        .then(response => {
            return response.json();
        }).then((responseJson) => {
          fentanylSourceData = responseJson;
          var fentanylZipCodeHash = transformResultsToZipCodeHash(fentanylSourceData);
          initializeZipCodeMapData(fentanylZipCodeHash);
        });
      }

      function getHeatMapColor(min, max, value) {
        console.log('min', min);
        console.log('max', max);
        console.log('value', value);

        var valuePercent = (value - min) / (max - min);

        // map value percent to lightness range of 30% to 80% (dark to light)
        var lightness = ((1 - ((valuePercent) * 0.5)) - 0.2) * 100;

        return 'hsl(0, 85%, ' + lightness + '%)';
      }

      function transformResultsToZipCodeHash(resultsResponse) {
        return resultsResponse.reduce((acc, result) => {
          if (acc[result.zip]) {
            acc[result.zip].reports += 1;
          } else {
            acc[result.zip] = {
              reports: 1
            };
          }

          return acc;
        }, {});
      }

      function getResultsRange(zipCodeHash) {
        if (Object.keys(zipCodeHash).length === 0) {
          return {
            min: 0,
            max: 0
          };
        }

        var firstResult = zipCodeHash[Object.keys(zipCodeHash)[0]];
        var initialRange = {
          min: firstResult.reports,
          max: firstResult.reports
        };

        return Object.keys(zipCodeHash).reduce((acc, key) => {
          var result = zipCodeHash[key];
          if (result.reports > acc.max){
            acc.max = result.reports;
          }
          if (result.reports < acc.min) {
            acc.min = result.reports;
          }
          return acc;
        }, initialRange);
      }

      function initializeZipCodeMapData(zipCodeHash) {
        var resultsRange = getResultsRange(zipCodeHash);
        
        map.data.setStyle(function(feature) {
          var styleOptions = {
            fillOpacity: 0,
            strokeColor: 'gray',
            strokeWeight: 1
          };
          
          var featureZip = feature.getProperty('ZCTA5CE10');
          var result = zipCodeHash[featureZip];
          if (result) {
            styleOptions.fillOpacity = 0.7;
            styleOptions.fillColor = getHeatMapColor(resultsRange.min, resultsRange.max, result.reports);
          }

          return styleOptions;
        });
        
        map.data.addListener('mouseover', function(event) {
          map.data.revertStyle();
          map.data.overrideStyle(event.feature, {strokeWeight: 4});

          var featureZip = event.feature.getProperty('ZCTA5CE10');

          var result = zipCodeHash[featureZip];
          var reports = result ? result.reports : 0;

          // set hover details
          document.getElementById('hover-details-title').textContent = 'Zip: ' + featureZip;
          document.getElementById('hover-details-content').textContent = 'Reports: ' + reports;
          document.getElementById('hover-details').style.display = 'block';
        });

        map.data.addListener('mouseout', function(event) {
          map.data.revertStyle();
          document.getElementById('hover-details').style.display = 'none';
        });
      }

      function clearMarkers() {
        markers.forEach(marker => {
          marker.setMap(null);
        });
        markers = [];
      }

      function initializeMarkerClusterData(results) {
        markers = results.map(result => {
          return new google.maps.Marker({
            position: {lat: Number(result.latitude), lng: Number(result.longitude)},
            //label: result.zip
          });
        });

        var markerCluster = new MarkerClusterer(map, markers,
            {imagePath: 'http://localhost:8080/images/m'});
      }

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 7,
          center: {lat: 42.007730, lng: -93.505678},
          styles: mapStyles,
          streetViewControl: false,
          mapTypeControl: false
        });

        map.data.loadGeoJson('ia-iowa-zip-codes-geo.min.json');

        document.getElementById('update-filters-button').addEventListener("click", applyFilters);

        getNaloxoneResults();
        getFentanylResults();
      }
    </script>
    <script src="filters.js"></script>
    <script src="http://localhost:8080/markerclusterer.js">
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCVwC8OSM9CqtXXQbEYM2tm43dIpdwQf7U&callback=initMap&libraries=geometry">
    </script>
  </body>
</html>