<!DOCTYPE html>
<html>
  <head>
    <style>
       #map {
        height: 400px;
        width: 100%;
       }
    </style>
  </head>
  <body>
    <h3>My Google Maps Demo</h3>
    <div id="map"></div>
    <script>
      // map styles
      var mapStyles = [
        {
          "featureType": "administrative",
          "elementType": "geometry",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "administrative.land_parcel",
          "elementType": "labels",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "poi",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "poi",
          "elementType": "labels.text",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "road",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "road",
          "elementType": "labels.icon",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "road.local",
          "elementType": "labels",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "transit",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        }
      ];

      var hoverInfo, map;

      function getNaloxoneResults() {
        fetch('naloxone.json')
          .then(response => {
            return response.json();
        }).then((responseJson) => {
          var naloxoneZipCodeHash = transformResultsToZipCodeHash(responseJson);
          initializeZipCodeMapData(naloxoneZipCodeHash);
        });
      }

      function getFentanylResults() {
        fetch('fentanyl.json')
        .then(response => {
            return response.json();
        }).then((responseJson) => {
          initializeMarkerClusterData(responseJson);
        });
      }

      function getHeatMapColor(min, max, value) {
        var lightness = (1 - (((value / (max - min)) * 0.5) + 0.3)) * 100;

        return 'hsl(0, 85%, ' + lightness + '%)';
      }

      function transformResultsToZipCodeHash(resultsResponse) {
        return resultsResponse.reduce((acc, result) => {
          if (acc[result.zip]) {
            acc[result.zip].reports += 1;
          } else {
            acc[result.zip] = {
              reports: 1
            };
          }

          return acc;
        }, {});
      }

      function getResultsRange(zipCodeHash) {
        var firstResult = zipCodeHash[Object.keys(zipCodeHash)[0]];
        var initialRange = {
          min: firstResult.reports,
          max: firstResult.reports
        };

        return Object.keys(zipCodeHash).reduce((acc, key) => {
          var result = zipCodeHash[key];
          if (result.reports > acc.max){
            acc.max = result.reports;
          }
          if (result.reports < acc.min) {
            acc.min = result.reports;
          }
          return acc;
        }, initialRange);
      }

      function initializeZipCodeMapData(zipCodeHash) {
        var resultsRange = getResultsRange(zipCodeHash);
        
        map.data.setStyle(function(feature) {
          var styleOptions = {
            fillOpacity: 0,
            strokeColor: 'gray',
            strokeWeight: 1
          };
          
          var featureZip = feature.getProperty('ZCTA5CE10');
          var result = zipCodeHash[featureZip];
          if (result) {
            styleOptions.fillOpacity = 0.7;
            styleOptions.fillColor = getHeatMapColor(resultsRange.min, resultsRange.max, result.reports);
          }

          return styleOptions;
        });
        
        map.data.addListener('mouseover', function(event) {
          map.data.revertStyle();
          map.data.overrideStyle(event.feature, {strokeWeight: 4});

          var featureZip = event.feature.getProperty('ZCTA5CE10');

          var result = zipCodeHash[featureZip];
          var reports = result ? result.reports : 0;

          hoverInfo = new google.maps.InfoWindow({
            position: event.latLng,
            content: 'Zip: ' + event.feature.getProperty('ZCTA5CE10') + ', Reports: ' + reports
          });

          hoverInfo.setMap(map);
        });

        map.data.addListener('mouseout', function(event) {
          hoverInfo.setMap(null);
          hoverInfo = null;
          map.data.revertStyle();
        });

        map.data.addListener('mousemove', function(event) {
          if(hoverInfo) {
            hoverInfo.setPosition(event.latLng);
          }
        });
      }

      function initializeMarkerClusterData(results) {
        var markers = results.map(result => {
          return new google.maps.Marker({
            position: {lat: Number(result.latitude), lng: Number(result.longitude)},
            label: result.zip
          });
        });

        var markerCluster = new MarkerClusterer(map, markers,
            {imagePath: 'http://localhost:8080/images/m'});
      }

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 7,
          center: {lat: 42.007730, lng: -93.505678},
          styles: mapStyles
        });

        map.data.loadGeoJson('ia_iowa_zip_codes_geo.min.json');

        getNaloxoneResults();
        getFentanylResults();
      }
    </script>
    <script src="http://localhost:8080/markerclusterer.js">
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCVwC8OSM9CqtXXQbEYM2tm43dIpdwQf7U&callback=initMap&libraries=geometry">
    </script>
  </body>
</html>