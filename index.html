<!DOCTYPE html>
<html>
  <head>
    <style>
       #map {
        height: 400px;
        width: 100%;
       }
    </style>
  </head>
  <body>
    <h3>My Google Maps Demo</h3>
    <div id="map"></div>
    <script>
      // map styles
      var mapStyles = [
        {
          "featureType": "administrative",
          "elementType": "geometry",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "administrative.land_parcel",
          "elementType": "labels",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "poi",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "poi",
          "elementType": "labels.text",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "road",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "road",
          "elementType": "labels.icon",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "road.local",
          "elementType": "labels",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "transit",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        }
      ];

      var hoverInfo;

      function getNaloxoneResults() {
        fetch('naloxone.json')
          .then(response => {
            return response.json();
        }).then((responseJson) => {
          var naloxoneResults = transformNaloxoneResults(responseJson);
          initMap(naloxoneResults);
        });
      }

      function getColor(min, max, value) {
        var lightness = (1 - (((value / (max - min)) * 0.5) + 0.3)) * 100;

        return 'hsl(0, 85%, ' + lightness + '%)';
      }

      function transformNaloxoneResults(naloxoneResponse) {
        return naloxoneResponse.reduce((acc, naloxoneResult) => {
          if (acc[naloxoneResult.zip]) {
            acc[naloxoneResult.zip].reports += 1;
          } else {
            acc[naloxoneResult.zip] = {
              reports: 1
            };
          }

          return acc;
        }, {});
      }

      function getResultsRange() {}

      function initMap(naloxoneResults) {
        var resultsMin = 0, resultsMax = 10;
        
        // TODO: compute results max and mins

        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 7,
          center: {lat: 42.007730, lng: -93.505678},
          styles: mapStyles
        });

        map.data.loadGeoJson('ia_iowa_zip_codes_geo.min.json');
        
        map.data.setStyle(function(feature) {
          var styleOptions = {
            fillOpacity: 0,
            strokeColor: 'gray',
            strokeWeight: 1
          };
          
          var featureZip = feature.getProperty('ZCTA5CE10');
          var result = naloxoneResults[featureZip];
          if (result) {
            styleOptions.fillOpacity = 0.7;
            styleOptions.fillColor = getColor(resultsMin, resultsMax, result.reports);
          }

          return styleOptions;
        });
        
        // When the user hovers, tempt them to click by outlining the letters.
        // Call revertStyle() to remove all overrides. This will use the style rules
        // defined in the function passed to setStyle()
        map.data.addListener('mouseover', function(event) {
          map.data.revertStyle();
          map.data.overrideStyle(event.feature, {strokeWeight: 4});

          var featureZip = event.feature.getProperty('ZCTA5CE10');

          var result = naloxoneResults[featureZip];
          var reports = result ? result.reports : 0;

          hoverInfo = new google.maps.InfoWindow({
            position: event.latLng,
            content: 'Zip: ' + event.feature.getProperty('ZCTA5CE10') + ', Reports: ' + reports
          });

          hoverInfo.setMap(map);
        });

        map.data.addListener('mouseout', function(event) {
          hoverInfo.setMap(null);
          hoverInfo = null;
          map.data.revertStyle();
        });

        map.data.addListener('mousemove', function(event) {
          if(hoverInfo) {
            hoverInfo.setPosition(event.latLng);
          }
        });
      }
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCVwC8OSM9CqtXXQbEYM2tm43dIpdwQf7U&callback=getNaloxoneResults&libraries=geometry">
    </script>
  </body>
</html>