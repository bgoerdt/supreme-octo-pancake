<!DOCTYPE html>
<html>
  <head>
    <style>
       #map {
        height: 400px;
        width: 100%;
       }
    </style>
  </head>
  <body>
    <h3>My Google Maps Demo</h3>

    <h3>Fentanyl Filters</h3>
    <p>Date of Testing</p>
    <span>From: <input type="date" /></span>
    <span>To: <input type="date" /></span>
    
    <p>Drug Type</p>
    <input id="fentanyl_checkbox_drugtype_meth" type="checkbox" value="Methamphetamine" />
    <label for="fentanyl_checkbox_drugtype_meth">Methamphetamine</label><br/>

    <input id="fentanyl_checkbox_drugtype_opioids" type="checkbox" value="Opioids" />
    <label for="fentanyl_checkbox_drugtype_opioids">Opioids</label><br/>

    <input id="fentanyl_checkbox_drugtype_heroin" type="checkbox" value="Heroin" />
    <label for="fentanyl_checkbox_drugtype_heroin">Heroin</label><br/>

    <input id="fentanyl_checkbox_drugtype_crack" type="checkbox" value="Crack/Cocaine" />
    <label for="fentanyl_checkbox_drugtype_crack">Crack/Cocaine</label><br/>

    <input id="fentanyl_checkbox_drugtype_other" type="checkbox" value="Other not on the list" />
    <label for="fentanyl_checkbox_drugtype_other">Other not on the list</label><br/>

    <p>Use of Test Strips</p>
    <input id="fentanyl_checkbox_use_before" type="checkbox" value="Before drug use" />
    <label for="fentanyl_checkbox_use_before">Before using the drug</label><br/>

    <input id="fentanyl_checkbox_use_after" type="checkbox" value="After drug use" />
    <label for="fentanyl_checkbox_use_after">After using the drug</label><br/>

    <p>Test Results</p>
    <input id="fentanyl_checkbox_results_positive" type="checkbox" value="Positive" />
    <label for="fentanyl_checkbox_results_positive">Positive</label><br/>

    <input id="fentanyl_checkbox_results_negative" type="checkbox" value="Negative" />
    <label for="fentanyl_checkbox_results_negative">Negative</label><br/>

    <input id="fentanyl_checkbox_results_none" type="checkbox" value="Didn\u00e2\u0080\u0099t work" />
    <label for="fentanyl_checkbox_results_none">Didn't work</label><br/>

    <p>Actions</p>
    <input id="fentanyl_checkbox_actions_sameamount" type="checkbox" value="i-used-the-same-amount-of-drugs-as-i-planned" />
    <label for="fentanyl_checkbox_actions_sameamount">I used the same amount of drugs as I planned</label><br/>

    <input id="fentanyl_checkbox_actions_less" type="checkbox" value="i-used-less-amount-of-drugs-than-i-planned" />
    <label for="fentanyl_checkbox_actions_less">I used less amount of drugs than I planned</label><br/>

    <input id="fentanyl_checkbox_actions_slowplunger" type="checkbox" value="i-pushed-plunger-more-slowly-than-usual" />
    <label for="fentanyl_checkbox_actions_slowplunger">I pushed plunger more slowly than usual</label><br/>

    <input id="fentanyl_checkbox_actions_plungerpartway" type="checkbox" value="i-pushed-plunger-partway-to-feel-how-strong-the-drug-was" />
    <label for="fentanyl_checkbox_actions_plungerpartway">I pushed plunger partway to feel how strong the drug was</label><br/>

    <input id="fentanyl_checkbox_actions_sniffed" type="checkbox" value="i-sniffed-it-instead-of-shooting" />
    <label for="fentanyl_checkbox_actions_sniffed">I sniffed it instead of shooting it</label><br/>

    <input id="fentanyl_checkbox_actions_threwaway" type="checkbox" value="i-threw-the-drugs-away" />
    <label for="fentanyl_checkbox_actions_threwaway">I threw the drugs away</label><br/>

    <input id="fentanyl_checkbox_actions_lookafter" type="checkbox" value="i-got-someone-to-look-after-me" />
    <label for="fentanyl_checkbox_actions_lookafter">I got someone to look after me</label><br/>

    <input id="fentanyl_checkbox_actions_sharedresults" type="checkbox" value="i-shared-the-test-results-with-other-people-who-use-the-same-drug" />
    <label for="fentanyl_checkbox_actions_sharedresults">I shared the test results with other people who use the same drug</label><br/>

    <input id="fentanyl_checkbox_actions_other" type="checkbox" value="other-not-on-the-list" />
    <label for="fentanyl_checkbox_actions_other">Other not on the list</label><br/>

    <p>Method of Use</p>
    <input id="fentanyl_checkbox_method_inject" type="checkbox" value="i-injected-it" />
    <label for="fentanyl_checkbox_method_inject">I injected it</label><br/>

    <input id="fentanyl_checkbox_method_snorted" type="checkbox" value="i-snorted-or-sniffed-it" />
    <label for="fentanyl_checkbox_method_snorted">I snorted or sniffed it</label><br/>

    <input id="fentanyl_checkbox_method_smoked" type="checkbox" value="i-smoked-it" />
    <label for="fentanyl_checkbox_method_smoked">I smoked it</label><br/>

    <input id="fentanyl_checkbox_method_didnotuse" type="checkbox" value="I didn\u00e2\u0080\u0099t use it" />
    <label for="fentanyl_checkbox_method_didnotuse">I didn't use it</label><br/>

    <input id="fentanyl_checkbox_method_other" type="checkbox" value="other-not-listed" />
    <label for="fentanyl_checkbox_method_other">Other not listed</label><br/>

    <p>Under 30</p>
    <input id="fentanyl_checkbox_under30_yes" type="checkbox" value="yes" />
    <label for="fentanyl_checkbox_under30_yes">Yes</label><br/>
    
    <input id="fentanyl_checkbox_under30_no" type="checkbox" value="no" />  
    <label for="fentanyl_checkbox_under30_no">No</label><br/>

    <div id="map"></div>
    <script>
      // map styles
      var mapStyles = [
        {
          "featureType": "administrative",
          "elementType": "geometry",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "administrative.land_parcel",
          "elementType": "labels",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "poi",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "poi",
          "elementType": "labels.text",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "road",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "road",
          "elementType": "labels.icon",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "road.local",
          "elementType": "labels",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "featureType": "transit",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        }
      ];

      var hoverInfo, map;

      function getNaloxoneResults() {
        fetch('naloxone.json')
          .then(response => {
            return response.json();
        }).then((responseJson) => {
          var naloxoneZipCodeHash = transformResultsToZipCodeHash(responseJson);
          initializeZipCodeMapData(naloxoneZipCodeHash);
        });
      }

      function getFentanylResults() {
        fetch('fentanyl.json')
        .then(response => {
            return response.json();
        }).then((responseJson) => {
          initializeMarkerClusterData(responseJson);
        });
      }

      function getHeatMapColor(min, max, value) {
        var lightness = (1 - (((value / (max - min)) * 0.5) + 0.3)) * 100;

        return 'hsl(0, 85%, ' + lightness + '%)';
      }

      function transformResultsToZipCodeHash(resultsResponse) {
        return resultsResponse.reduce((acc, result) => {
          if (acc[result.zip]) {
            acc[result.zip].reports += 1;
          } else {
            acc[result.zip] = {
              reports: 1
            };
          }

          return acc;
        }, {});
      }

      function getResultsRange(zipCodeHash) {
        var firstResult = zipCodeHash[Object.keys(zipCodeHash)[0]];
        var initialRange = {
          min: firstResult.reports,
          max: firstResult.reports
        };

        return Object.keys(zipCodeHash).reduce((acc, key) => {
          var result = zipCodeHash[key];
          if (result.reports > acc.max){
            acc.max = result.reports;
          }
          if (result.reports < acc.min) {
            acc.min = result.reports;
          }
          return acc;
        }, initialRange);
      }

      function initializeZipCodeMapData(zipCodeHash) {
        var resultsRange = getResultsRange(zipCodeHash);
        
        map.data.setStyle(function(feature) {
          var styleOptions = {
            fillOpacity: 0,
            strokeColor: 'gray',
            strokeWeight: 1
          };
          
          var featureZip = feature.getProperty('ZCTA5CE10');
          var result = zipCodeHash[featureZip];
          if (result) {
            styleOptions.fillOpacity = 0.7;
            styleOptions.fillColor = getHeatMapColor(resultsRange.min, resultsRange.max, result.reports);
          }

          return styleOptions;
        });
        
        map.data.addListener('mouseover', function(event) {
          map.data.revertStyle();
          map.data.overrideStyle(event.feature, {strokeWeight: 4});

          var featureZip = event.feature.getProperty('ZCTA5CE10');

          var result = zipCodeHash[featureZip];
          var reports = result ? result.reports : 0;

          hoverInfo = new google.maps.InfoWindow({
            position: event.latLng,
            content: 'Zip: ' + event.feature.getProperty('ZCTA5CE10') + ', Reports: ' + reports
          });

          hoverInfo.setMap(map);
        });

        map.data.addListener('mouseout', function(event) {
          hoverInfo.setMap(null);
          hoverInfo = null;
          map.data.revertStyle();
        });

        map.data.addListener('mousemove', function(event) {
          if(hoverInfo) {
            hoverInfo.setPosition(event.latLng);
          }
        });
      }

      function initializeMarkerClusterData(results) {
        var markers = results.map(result => {
          return new google.maps.Marker({
            position: {lat: Number(result.latitude), lng: Number(result.longitude)},
            label: result.zip
          });
        });

        var markerCluster = new MarkerClusterer(map, markers,
            {imagePath: 'http://localhost:8080/images/m'});
      }

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 7,
          center: {lat: 42.007730, lng: -93.505678},
          styles: mapStyles
        });

        map.data.loadGeoJson('ia_iowa_zip_codes_geo.min.json');

        getNaloxoneResults();
        getFentanylResults();
      }
    </script>
    <script src="http://localhost:8080/markerclusterer.js">
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCVwC8OSM9CqtXXQbEYM2tm43dIpdwQf7U&callback=initMap&libraries=geometry">
    </script>
  </body>
</html>